name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_sticky_comment: "true"
          additional_permissions: |
            actions: read
          prompt: |
            You are reviewing PR #${{ github.event.pull_request.number }} in ${{ github.repository }}.

            ## Pre-Review Setup (Required)

            1. Read CLAUDE.md at the repo root for project conventions
            2. Run `gh pr diff ${{ github.event.pull_request.number }}` to get the full diff

            ## Review Criteria (Priority Order)

            ### Project-Specific Rules (from CLAUDE.md)
            - Component files must not exceed 200 lines
            - All colours must use semantic design tokens â€” FORBIDDEN: `text-gray-*`, `bg-blue-*`, `border-red-*`, or any Tailwind color with a numeric suffix. ALLOWED: `text-foreground`, `text-muted-foreground`, `bg-primary`, `border-border`, `text-destructive`, `bg-card`, etc.
            - All user-facing text must use i18n keys via `useTranslation()` (no hardcoded English strings)
            - Tests must use `data-testid` selectors, never CSS class selectors
            - New components require `.tsx` + `.stories.tsx` + `.test.tsx`
            - No `eslint-disable` comments without justification
            - Atomic design: atoms â†’ molecules â†’ organisms (components in correct layer)
            - Mock mode is dev/test only â€” never expose Mock selection UI in `/config`

            ### General Code Quality
            1. **Correctness**: Logic errors, unhandled edge cases, race conditions
            2. **Security**: XSS, injection, exposed secrets, unsafe data handling
            3. **Performance**: Unnecessary computations, memory leaks, N+1 patterns
            4. **Error handling**: Missing try/catch, unhandled promise rejections

            ## Severity Levels (Mandatory â€” assign one per issue)

            - ðŸ”´ **Critical** â€” Production failure, security breach, data corruption. MUST fix before merge.
            - ðŸŸ  **High** â€” Significant bugs, performance degradation. Should fix before merge.
            - ðŸŸ¡ **Medium** â€” Best practice deviation, technical debt. Consider improvement.
            - ðŸŸ¢ **Low** â€” Typos, docs, formatting. Author's discretion.

            Severity rules:
            - Constitutional violations (200-line, design tokens, i18n, missing tests): ðŸŸ  or ðŸ”´
            - Security issues: ðŸ”´
            - Typos, comments, docs: ðŸŸ¢
            - Test files: ðŸŸ¢ or ðŸŸ¡

            ## Review Rules (Strict)

            1. **Fact-based only** â€” DO NOT add comments that ask to "check", "verify", or "confirm". Only report verifiable issues.
            2. **No padding** â€” Do not praise code or repeat what it does correctly.
            3. **Concise** â€” One issue per comment, with file:line reference.
            4. **Actionable** â€” Provide a code suggestion when possible.
            5. **Confident only** â€” Only report issues you are certain about.

            ## Output Format

            Post your review using `gh pr comment` with this format:

            ## PR Review

            ### Summary
            (1-2 sentences: what the PR does and overall quality assessment)

            ### Issues Found

            ðŸ”´ **file.tsx:42** â€” [200-line violation] Component is 247 lines, exceeds limit
            ðŸŸ  **page.tsx:15** â€” [Design token violation] Uses hardcoded `text-gray-600`, should be `text-muted-foreground`
            ðŸŸ¡ **component.tsx:8** â€” [Missing tests] New component lacks `.test.tsx`
            ðŸŸ¢ **readme.md:3** â€” Typo: "configuraton" â†’ "configuration"

            (If no issues found, just write "No issues found.")

            ### Verdict
            - ðŸš« **Changes requested** (if any ðŸ”´ or ðŸŸ  issues)
            - ðŸ’¡ **LGTM with suggestions** (if only ðŸŸ¡ or ðŸŸ¢ issues)
            - âœ… **LGTM** (if no issues)
          claude_args: |
            --model claude-opus-4-6
            --max-turns 10
            --allowedTools "Read,Grep,Glob,Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr comment:*)"
