name: CI

on:

  pull_request:
  workflow_call: # Allow this workflow to be called by deploy.yml

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    # For workflow_call (from deploy.yml), there's no PR context,
    # so paths-filter can't diff. We force all jobs to run.
    outputs:
      run_all: ${{ steps.trigger.outputs.run_all }}
      shared_utils: ${{ steps.trigger.outputs.run_all == 'true' && 'true' || steps.filter.outputs.shared_utils }}
      component_library: ${{ steps.trigger.outputs.run_all == 'true' && 'true' || steps.filter.outputs.component_library }}
      app: ${{ steps.trigger.outputs.run_all == 'true' && 'true' || steps.filter.outputs.app }}
      e2e: ${{ steps.trigger.outputs.run_all == 'true' && 'true' || steps.filter.outputs.e2e }}
      analysis: ${{ steps.trigger.outputs.run_all == 'true' && 'true' || steps.filter.outputs.analysis }}
    steps:
      - uses: actions/checkout@v4

      - name: Check trigger type
        id: trigger
        run: |
          if [ "${{ github.event_name }}" = "workflow_call" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "run_all=true" >> $GITHUB_OUTPUT
          else
            echo "run_all=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect changed paths
        if: steps.trigger.outputs.run_all != 'true'
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            shared_utils:
              - 'packages/shared-utils/**'
              - 'packages/consensus-core/**'
              - 'packages/consensus-standard/**'
              - 'packages/consensus-elo/**'
              - 'packages/consensus-majority/**'
              - 'packages/consensus-council/**'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig*.json'
              - '.github/workflows/ci.yml'

            component_library:
              - 'packages/component-library/**'
              - 'packages/shared-utils/**'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig*.json'
              - '.github/workflows/ci.yml'

            app:
              - 'packages/app/**'
              - 'packages/component-library/**'
              - 'packages/shared-utils/**'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig*.json'
              - '.github/workflows/ci.yml'

            e2e:
              - 'packages/e2e/**'
              - 'packages/app/**'
              - 'packages/component-library/**'
              - 'packages/shared-utils/**'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig*.json'
              - '.github/workflows/ci.yml'

            analysis:
              - 'packages/**'
              - 'scripts/**'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig*.json'
              - '.github/workflows/ci.yml'
              - '!**/*.md'

  component-library:
    name: Component Library
    needs: [detect-changes]
    if: needs.detect-changes.outputs.component_library == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run lint --workspace=packages/component-library
      - run: npm run test:unit --workspace=packages/component-library
      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(npx playwright --version | awk '{print $2}')" >> $GITHUB_OUTPUT
        working-directory: packages/component-library
      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}
      - name: Install Playwright browsers
        # On GitHub-hosted ubuntu-latest runners, Chromium system deps are preinstalled.
        # We only ensure browser binaries are present to avoid flaky apt repository failures.
        run: npx playwright install chromium
        working-directory: packages/component-library
      - run: npm run test:storybook:ci --workspace=packages/component-library

  shared-utils:
    name: Shared Utils
    needs: [detect-changes]
    if: needs.detect-changes.outputs.shared_utils == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Test consensus packages
        run: |
          npm run test --workspace=packages/consensus-core
          npm run test --workspace=packages/consensus-standard
          npm run test --workspace=packages/consensus-elo
          npm run test --workspace=packages/consensus-majority
          npm run test --workspace=packages/consensus-council
      - run: npm run test --workspace=packages/shared-utils
        env:
          OPENAI_API_KEY: ${{ secrets.TEST_OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.TEST_ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.TEST_GOOGLE_API_KEY }}
          XAI_API_KEY: ${{ secrets.TEST_XAI_API_KEY }}

  app:
    name: App
    needs: [detect-changes]
    if: needs.detect-changes.outputs.app == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Cache shared-utils build
        uses: actions/cache@v4
        with:
          path: packages/shared-utils/dist
          key: shared-utils-build-${{ hashFiles('packages/shared-utils/src/**', 'packages/shared-utils/tsconfig*.json') }}
      - name: Build consensus packages
        run: |
          npm run build --workspace=packages/consensus-core
          npm run build --workspace=packages/consensus-standard
          npm run build --workspace=packages/consensus-elo
          npm run build --workspace=packages/consensus-majority
          npm run build --workspace=packages/consensus-council
      - run: npm run build --workspace=packages/shared-utils
      - run: npm run lint --workspace=packages/app
      - run: npm run typecheck --workspace=packages/app
      - run: npm run build --workspace=packages/app

  # Mock Mode E2E Tests
  # Uses mock API clients, no real API keys needed
  app-e2e-mock:
    name: App E2E (Mock Mode)
    needs: [detect-changes]
    if: needs.detect-changes.outputs.e2e == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Cache shared-utils build
        uses: actions/cache@v4
        with:
          path: packages/shared-utils/dist
          key: shared-utils-build-${{ hashFiles('packages/shared-utils/src/**', 'packages/shared-utils/tsconfig*.json') }}
      - name: Build consensus packages
        run: |
          npm run build --workspace=packages/consensus-core
          npm run build --workspace=packages/consensus-standard
          npm run build --workspace=packages/consensus-elo
          npm run build --workspace=packages/consensus-majority
          npm run build --workspace=packages/consensus-council
      - run: npm run build --workspace=packages/shared-utils
      - run: npm run build --workspace=packages/app
      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(npx playwright --version | awk '{print $2}')" >> $GITHUB_OUTPUT
        working-directory: packages/e2e
      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}
      - name: Install Playwright browsers
        # On GitHub-hosted ubuntu-latest runners, Chromium system deps are preinstalled.
        # We only ensure browser binaries are present to avoid flaky apt repository failures.
        run: npx playwright install chromium
        working-directory: packages/e2e
      - name: Run Mock Mode E2E Tests
        run: npm run test:mock --workspace=packages/e2e
        env:
          E2E_MODE: 'mock'
          NEXT_PUBLIC_MOCK_MODE: 'true'

  # Note: Free Mode and Pro Mode E2E tests run post-deployment in deploy.yml
  # They test against the actual deployed infrastructure

  analysis:
    name: Static Analysis
    needs: [detect-changes]
    if: needs.detect-changes.outputs.analysis == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run analyze:fta
