name: Eval Baseline (Manual)

on:
  workflow_dispatch:

concurrency:
  group: eval-post-merge
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  update-baseline:
    name: Update Eval Baseline
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      GOOGLE_API_KEY: ${{ secrets.TEST_GOOGLE_API_KEY }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci --ignore-scripts
      - run: npm rebuild

      - name: Check Google API key is configured
        id: check-keys
        run: |
          if [ -z "$GOOGLE_API_KEY" ]; then
            echo "::warning::TEST_GOOGLE_API_KEY is not set. Skipping baseline update."
            echo "keys_available=false" >> "$GITHUB_OUTPUT"
          else
            echo "keys_available=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Restore HuggingFace dataset cache
        if: steps.check-keys.outputs.keys_available == 'true'
        uses: actions/cache@v4
        with:
          path: packages/eval/datasets
          key: eval-datasets-v2
          restore-keys: eval-datasets-

      - name: Restore single-model baseline cache
        if: steps.check-keys.outputs.keys_available == 'true'
        uses: actions/cache@v4
        with:
          path: packages/eval/.cache/baselines
          key: eval-baseline-${{ hashFiles('packages/eval/src/lib/baselineCache.ts') }}-${{ github.sha }}
          restore-keys: |
            eval-baseline-${{ hashFiles('packages/eval/src/lib/baselineCache.ts') }}-
            eval-baseline-

      - name: Build consensus packages
        if: steps.check-keys.outputs.keys_available == 'true'
        run: |
          npm run build --workspace=packages/consensus-core
          npm run build --workspace=packages/consensus-standard
          npm run build --workspace=packages/consensus-elo
          npm run build --workspace=packages/consensus-majority
          npm run build --workspace=packages/consensus-council

      - name: Build shared-utils
        if: steps.check-keys.outputs.keys_available == 'true'
        run: npm run build --workspace=packages/shared-utils

      - name: Build eval
        if: steps.check-keys.outputs.keys_available == 'true'
        run: npm run build --workspace=packages/eval

      - name: Run quick eval and save baseline
        if: steps.check-keys.outputs.keys_available == 'true'
        working-directory: packages/eval
        run: |
          node --import tsx bin/ensemble-eval.mjs quick-eval \
            --model google:gemini-3-flash-preview \
            --strategies standard,elo,majority,council \
            --sample 50 \
            --baseline baselines/quick-eval.json

      - name: Upload generated baseline
        if: steps.check-keys.outputs.keys_available == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: quick-eval-baseline
          path: packages/eval/baselines/quick-eval.json
          if-no-files-found: error
