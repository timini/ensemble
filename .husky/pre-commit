set -euo pipefail

# Only run checks for packages that have staged changes
# Dependency graph: shared-utils <- component-library <- app
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

CHANGED_COMPONENT_LIB=false
CHANGED_SHARED_UTILS=false
CHANGED_APP=false

if echo "$STAGED_FILES" | grep -q '^packages/component-library/'; then CHANGED_COMPONENT_LIB=true; fi
if echo "$STAGED_FILES" | grep -q '^packages/shared-utils/'; then CHANGED_SHARED_UTILS=true; fi
if echo "$STAGED_FILES" | grep -q '^packages/app/'; then CHANGED_APP=true; fi

# Component library depends on shared-utils
if [ "$CHANGED_COMPONENT_LIB" = true ] || [ "$CHANGED_SHARED_UTILS" = true ]; then
  echo "ğŸ§ª Component library quick checks..."
  npm run lint --workspace=packages/component-library
  npm run test:unit --workspace=packages/component-library
fi

if [ "$CHANGED_SHARED_UTILS" = true ]; then
  echo "ğŸ§© Shared utils tests..."
  npm run test --workspace=packages/shared-utils
fi

# App depends on both shared-utils and component-library
if [ "$CHANGED_APP" = true ] || [ "$CHANGED_SHARED_UTILS" = true ] || [ "$CHANGED_COMPONENT_LIB" = true ]; then
  echo "ğŸ—ï¸ App lint + typecheck..."
  npm run lint --workspace=packages/app
  npm run typecheck --workspace=packages/app
fi

if echo "$STAGED_FILES" | grep -q '^packages/'; then
  echo "ğŸ“Š Running FTA analysis..."
  npm run analyze:fta
fi
